# cosense-userscript-dev

A local development tool for Cosense (Scrapbox) UserScripts.

Write Cosense UserScripts in TypeScript, build and serve them locally, and see changes by just reloading the browser.

## How it works

```
scripts/*.ts → [Bun.build] → dist/*.js → [dev-server :3456] → [Tampermonkey] → runs on Cosense page
```

- **scripts/\*.ts** — Cosense UserScript source. These scripts use Cosense APIs like `cosense.PageMenu.addMenu()` and run in the Cosense page context.
- **Tampermonkey** — Acts as a **delivery mechanism** only. It fetches built JS from the local server and injects it into the Cosense page context. It is not the target of development.

### Why Tampermonkey?

Cosense's CSP (Content Security Policy) blocks `fetch` to `localhost`, so you cannot load scripts from a local server via `code:script.js` on a Cosense page. Tampermonkey's `GM_xmlhttpRequest` bypasses CSP, making it the delivery channel from the local dev server to the browser.

## Installation

No install required — use `bunx` to run directly:

```bash
bunx cosense-userscript-dev
```

Optionally, add it as a dev dependency for `defineConfig` type support in `cosense-dev.config.ts`:

```bash
bun add -d cosense-userscript-dev
```

## Quick Start

See [TUTORIAL.md](./TUTORIAL.md) for a detailed step-by-step walkthrough.

1. Create a `scripts/` directory and write Cosense UserScripts in TypeScript:

```
my-userscripts/
  scripts/
    foo.ts    ← uses cosense.PageMenu.addMenu(), etc.
    bar.ts
  package.json
```

2. Start the dev server:

```bash
bunx cosense-userscript-dev
```

3. Generate the Tampermonkey loader:

```bash
bunx cosense-userscript-dev loader
```

4. Copy the contents of `loader.user.js` into Tampermonkey (one-time setup). Reload a Cosense page to see your scripts in action.

## Commands

### `cosense-userscript-dev` (default: dev)

- Builds `scripts/*.ts` → `dist/*.js`
- Serves `dist/` via HTTP with CORS headers
- Watches `scripts/` for changes and auto-rebuilds

### `cosense-userscript-dev build`

- One-shot build of `scripts/*.ts` → `dist/*.js`

### `cosense-userscript-dev loader`

- Detects filenames in `dist/`
- Generates `loader.user.js` with the configured `port` and `match` patterns

## Configuration

No configuration is needed if you follow the default conventions. To customize, create a `cosense-dev.config.ts` file:

```ts
import { defineConfig } from 'cosense-userscript-dev';

// default values are used if not specified
export default defineConfig({
  scriptsDir: 'scripts',
  outDir: 'dist',
  port: 3456,
  match: ['https://scrapbox.io/*'],
});
```

## Project Structure (user side)

```
my-userscripts/
  scripts/          … Cosense UserScripts (TypeScript)
    foo.ts
    bar.ts
  dist/             … build output (add to .gitignore)
  loader.user.js    … Tampermonkey loader (generated by `loader` command)
  cosense-dev.config.ts  … optional config
  package.json
```

## License

MIT
